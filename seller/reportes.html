<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Vendedor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="js/seller.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/sidebar.js"></script>
    <style>
        .seller-container {
            margin-left: 260px;
            padding: 2rem 0;
            min-height: 80vh;
            animation: fadeInUp 0.7s cubic-bezier(.4,2,.6,1) 0.1s forwards;
            opacity: 0;
            transform: translateY(30px);
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: none;
            }
        }
        @media (max-width: 991.98px) {
            .seller-container {
                margin-left: 0;
                padding: 1rem 0.5rem;
            }
        }
        .logo{
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
    <script>
    function descargarCSV(nombre, cabeceras, filas) {
        let csv = cabeceras.join(',') + '\n';
        filas.forEach(fila => {
            csv += fila.map(campo => `"${String(campo).replace(/"/g, '""')}"`).join(',') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = nombre;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }

    $(function() {
        // Reporte de ventas por producto con filtro de fechas
        $('#btnReporteVentas').click(() => {
            const inicio = $('#fechaInicio').val();
            const fin = $('#fechaFin').val();
            let url = '../api/pedidos.php?accion=masvendidos';
            if (inicio) url += `&inicio=${encodeURIComponent(inicio)}`;
            if (fin) url += `&fin=${encodeURIComponent(fin)}`;
            $.get(url, function(response) {
                const cabeceras = ['Producto', 'Vendidos'];
                const filas = (response.productos || []).map(p => [p.nombre, p.cantidad_vendida]);
                descargarCSV('ventas_productos.csv', cabeceras, filas);
            });
        });

        // Modal de reporte de problema
        $('#btnReportarProblema').click(function() {
            $('#modalReporte').modal('show');
        });
        $('#enviarReporte').click(function() {
            const mensaje = $('#reporteMensaje').val();
            if (!mensaje.trim()) {
                alert('Por favor, describe el problema.');
                return;
            }
            // Aquí iría la lógica AJAX para enviar el reporte al backend
            alert('¡Reporte enviado! Gracias por tu comentario.');
            $('#modalReporte').modal('hide');
            $('#reporteMensaje').val('');
        });

        // Cerrar sesión
        $('#logoutBtn').click(function() {
            $.get('../api/auth.php?accion=logout', function(response) {
                if (response.success) {
                    window.location.href = '../auth/login.html';
                }
            });
        });
    });
    </script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <button class="btn btn-outline-light me-2" id="sidebarToggle" type="button">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="../index.html">
                <img src="../img/fondo1.jpg" class="logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">Panel Repartidor</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Cerrar Sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div id="sellerSidebar" class="sidebar-seller bg-dark text-white"></div>
    <div class="seller-container">
        <h2 class="mb-4">Reportes</h2>
        <div class="row g-4">
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-bar-chart"></i> Ventas por Producto
                    </div>
                    <div class="card-body">
                        <p>Descarga un reporte de ventas por producto en formato CSV.</p>
                        <div class="mb-2">
                            <label for="fechaInicio" class="form-label">Desde:</label>
                            <input type="date" class="form-control" id="fechaInicio">
                        </div>
                        <div class="mb-2">
                            <label for="fechaFin" class="form-label">Hasta:</label>
                            <input type="date" class="form-control" id="fechaFin">
                        </div>
                        <button class="btn btn-outline-primary w-100" id="btnReporteVentas">
                            <i class="bi bi-download"></i> Descargar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal de Reporte -->
        <div class="modal fade" id="modalReporte" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Reportar un Problema</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formReporte">
                            <div class="mb-3">
                                <label for="reporteMensaje" class="form-label">Describe el problema</label>
                                <textarea class="form-control" id="reporteMensaje" rows="4" required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="enviarReporte">Enviar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
